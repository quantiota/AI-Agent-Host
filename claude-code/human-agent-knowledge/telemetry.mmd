---
config:
  look: classic
  theme: base
  layout: elk
---
flowchart TD
    %% Input Layer
    terminal["Terminal Session<br/>(Claude Code)"]
    raw["Raw Data:<br/>• Keystrokes<br/>• Screen Output<br/>• Commands"]
    
    %% Dual Processing Paths
    subgraph "Real-Time Streaming Path"
        direction TB
        realtime_detect["Live Message Detection<br/>(Lightweight Classification)"]
        message_buffer["Message Buffer<br/>(2s timeout / 500 chars, debounce & merge)"]
        stream_insert["Stream Insert<br/>(Immediate QuestDB)"]
    end
    
    subgraph "Batch Validation Path"
        direction TB
        logs["Session Logs<br/>• session.log • timing.log • meta.json"]
        parser["Full Parse + Timestamp + Classify<br/>(Detailed Analysis)"]
        events["Structured Events<br/>(JSON/CSV)"]
        validate["Integrity Check & Gap Recovery<br/>(idempotent upsert)"]
    end
    
    %% Database Schema
    subgraph "QuestDB Storage Schema"
        direction TB
        questdb[("chat/events tables<br/>Time-series optimized")]
        schema["Schema Structure:<br/>• timestamp (TIMESTAMP)<br/>• session_id (SYMBOL)<br/>• message_type (SYMBOL)<br/>• content (STRING)<br/>• project_tag (SYMBOL)<br/>• tool_used (SYMBOL)<br/>• response_quality (DOUBLE)<br/>• context_tokens (INT)<br/>PARTITIONED BY DAY"]
    end
    
    %% Intelligence Layer
    grafana["Grafana Dashboards<br/>Real-time Analysis"]
    ska["Structured Knowledge Accumulation (SKA)"]
    
    %% Flow Connections
    terminal --> raw
    raw --> realtime_detect
    raw --> logs
    
    %% Real-time path
    realtime_detect --> message_buffer
    message_buffer --> stream_insert
    stream_insert --> questdb

    questdb --> extquestdb[("Exterior QuestDB Cluster<br/>Centralized Telemetry Repository")]
    extquestdb --> grafana
    extquestdb --> ska
    
    %% Batch validation path  
    logs --> parser
    parser --> events
    events --> validate
    validate --> questdb
    
    %% Schema connection
    questdb --> schema
    
    %% Intelligence layer
    questdb --> grafana
    questdb --> ska
    
    %% Styling
    classDef input fill:#e1f5fe,stroke:#01579b,stroke-width:0.5px
    classDef realtime fill:#e8f5e8,stroke:#2e7d32,stroke-width:0.5px
    classDef batch fill:#f3e5f5,stroke:#7b1fa2,stroke-width:0.5px
    classDef storage fill:#fff3e0,stroke:#f57c00,stroke-width:0.5px
    classDef schema fill:#f1f8e9,stroke:#33691e,stroke-width:0.5px
    classDef intelligence fill:#fce4ec,stroke:#c2185b,stroke-width:0.5px
    
    class terminal,raw input
    class realtime_detect,message_buffer,stream_insert realtime
    class logs,parser,events,validate batch
    class questdb storage
    class schema schema
    class grafana,ska intelligence
